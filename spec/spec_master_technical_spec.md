# **Master Technical Specification: Pecking Order**

**Version:** 7.0 (Final Source of Truth)

**Scope:** Full Stack Architecture, Data Schemas, Mechanic Implementations, and Client Strategy.

**Target Audience:** Implementation Agent / Lead Developer.

## **1\. Executive Summary**

**Pecking Order** is a 7-day persistent social deduction game.

* **Infrastructure:** Cloudflare Durable Objects (via PartyKit).  
* **Auth:** Magic Link (Passwordless) via Email.  
* **AI:** **Google Gemini** (via Vertex AI or Studio) for Persona Generation.  
* **Database:** Cloudflare D1 (SQLite) for Journal, Gold, and **Lobby State**.  
* **Notifications:** OneSignal (Web Push) \+ Sonner (In-App).  
* **Logic:** XState v5 (Server-Authoritative).  
* **Client:** React PWA \+ WebSockets.

## **2\. The Architectural Hierarchy (Russian Doll)**

The system is split into two phases: **Pre-Game (Lobby)** and **Active Game (Engine)**.

| Layer | Component | Responsibility | State Pattern |
| :---- | :---- | :---- | :---- |
| **P1** | **Lobby Service** (Web App) | **Pre-Game Host.** Manages Invites, **Gemini AI Generation**, Bio Editing, and Roster Finalization. | CRUD / REST |
| **L0** | **Client Shell** (React PWA) | **View / OS.** Manages Chat, Navigation, **Service Workers**, and **Install Prompts**. | SPA / Lazy Loading |
| **L1** | **Infrastructure** (PartyKit) | **System Host.** Manages WebSocket connections, Alarms, Snapshots (Survival), and **Push Notifications**. | Durable Object |
| **L2** | **Orchestrator** (Contest) | **Authority.** Manages **Active Roster**, Destinies, Gold, Elimination, and Journal Queries. | Parent Actor |
| **L3** | **Daily Session** (Console) | **Gameplay.** Runs Social OS, Activities, and Cartridges in parallel. | Parallel Actor |
| **L3.1** | **Cartridge** (Minigame) | **Mechanic.** Pluggable logic (Trivia, Voting). | Ephemeral Actor |

## **3\. Data Schemas (The Contracts)**

### **3.1 The Lobby State (P1 Database \- D1)**

Managed by the Lobby Service. Not part of the XState machine.

interface LobbyRecord {  
  id: string; // Game ID  
  hostEmail: string;  
  status: "OPEN" | "FULL" | "HANDOFF\_COMPLETE";  
  personaDeck: PersonaOption\[\]; // Generated by Gemini  
  players: {  
    email: string;  
    status: "PENDING" | "READY";  
    personaId?: string;  
    bio?: string;  
  }\[\];  
}

interface PersonaOption {  
  id: string;  
  name: string;  
  avatarUrl: string; // Generated via AI  
  bioTemplate: string; // Generated via AI  
}

### **3.2 The Player Roster (L2 Context \- Active Game)**

The authoritative state passed from P1 to L2 upon game start.

interface Roster {  
  \[playerId: string\]: {  
    // Identity (Frozen from Lobby)  
    realUserId: string;  
    personaName: string;  
    avatar: string;   
    bio: string;  
      
    // Status (Managed by L2)  
    isAlive: boolean;  
    isSpectator: boolean;  
      
    // Currencies  
    silver: number; // Ephemeral (resets daily)  
    gold: number;   // Permanent (synced from D1 User Table)  
      
    // Hidden  
    destinyId: string; // "FANATIC"  
    destinyStatus: "PENDING" | "FAILED" | "COMPLETED";  
  }  
}

### **3.3 The Contest Manifest (L2 Input)**

Defines the structure of the week. Loaded by L2 at startup.

interface ContestManifest {  
  id: string; // "tournament\_alpha"  
  destinies: DestinyDefinition\[\]; // Pool of possible destinies  
  days: DailyManifest\[\]; // 7 configs  
}

interface DestinyDefinition {  
  id: string; // "FANATIC"  
  description: string; // "Win if eliminated first"  
  trigger: "ELIMINATION" | "END\_GAME";  
  conditionLogic: string; // "dayIndex \=== 1" (Evaluated by L2)  
}

### **3.4 The Daily Manifest (L3 Input)**

Defines the timeline for a specific day. Used to schedule INTERNAL injections.

interface DailyManifest {  
  dayIndex: number;  
  theme: string; // "Double Trouble"  
  timeline: Array\<{  
    time: string; // "09:15"  
    target: "MAIN\_STAGE" | "ACTIVITY";  
    action: "START\_CARTRIDGE" | "INJECT\_PROMPT" | "START\_ACTIVITY";  
    payload: any; // { cartridgeId: "TRIVIA" }  
  }\>;  
}

### **3.5 The Journal Schema (D1 / SQL)**

Used for verifying Destinies ("Float", "Detective") and auditing.

CREATE TABLE GameJournal (  
  id TEXT PRIMARY KEY,  
  game\_id TEXT,  
  day\_index INTEGER,  
  timestamp INTEGER,  
  event\_type TEXT,      \-- "SILVER\_TRANSFER", "VOTE\_CAST", "ELIMINATION", "DM\_SENT", "POWER\_USED"  
  actor\_id TEXT,  
  target\_id TEXT,  
  payload TEXT,         \-- JSON: { "balance\_after": 10, "role": "DETECTIVE" }  
  trace\_id TEXT         \-- Links back to original websocket request  
);

## **4\. Mechanic Implementations**

### **4.1 Registration & Setup (The "Lobby Service")**

* **Gemini Integration:**  
  * Host clicks "Create".  
  * P1 calls Google Gemini API: *"Generate 24 diverse, funny persona names and bios for a social deduction game."*  
  * P1 stores results in D1 LobbyRecord.  
* **Invite Flow:** P1 sends emails with Magic Links (pointing to the Lobby App).  
* **The Handoff (Critical):**  
  * When Player 8 clicks "Ready":  
  * P1 compiles the Roster JSON.  
  * P1 calls POST https://partykit-host/game/init with the Roster.  
  * L1 initializes L2.  
  * L2 sets the "Start Tomorrow 9 AM" alarm.  
  * P1 emails everyone: "Game Starts Tomorrow\!"

### **4.2 Destinies (The Meta-Game)**

* **Assignment:** L2 assigns random destinies during Setup state. Stored in context.roster.  
* **Tracking:**  
  * L3 emits FACT.RECORD for every relevant action (Silver change, Vote).  
  * L2 writes these to D1 Journal.  
* **Evaluation:**  
  * **Trigger:** DaySummary (for "Fanatic") or EndGame (for "Float").  
  * **Logic:** L2 queries D1 Journal.  
  * **Example (Fanatic):** SELECT count(\*) FROM GameJournal WHERE event\_type \= 'ELIMINATION' AND target\_id \= 'PlayerA' AND day\_index \= 1;

### **4.3 Economy (Silver vs. Gold)**

* **Silver:** High-frequency. Managed in L3 RAM (Context).  
  * *Earned:* Minigames (Cartridges).  
  * *Spent:* DMs (Social OS).  
  * *Persistence:* Saved via Snapshots (L1).  
* **Gold:** Low-frequency. Managed in D1 (User Table).  
  * *Earned:* Destiny Completion, Weekly Win.  
  * *Persistence:* L2 updates D1 Users table at EndGame.

### **4.4 Voting & Elimination**

* **Voting:** Handled by a Cartridge (EXECUTIONER or TRUST\_PAIR) in L3.  
* **Result:** Cartridge emits FACT.VOTE\_RESULT.  
* **Elimination:** L2 processes the result in DaySummary. Updates roster\[id\].isAlive \= false.

### **4.5 Powers (Privacy Leaks)**

* **Trigger:** Client sends SOCIAL.POWER { type: 'SPY', target: 'Alice' }.  
* **Flow:**  
  1. L3 deducts Silver. Emits FACT.RECORD { type: 'POWER\_USED', effect: 'SPY' }.  
  2. L2 intercepts Fact. Queries D1 Journal for Alice's last 3 DMs.  
  3. L2 sends SYSTEM.PRIVATE\_MESSAGE via L1 to the requester only.

## **5\. Event Protocol (Namespaces)**

All events must follow the strict DOMAIN.CONTEXT.VERB format.

| Namespace | Usage | Routing Behavior |
| :---- | :---- | :---- |
| SYSTEM.INIT | P1 \-\> L1 (Webhook). | **Startup.** Initializes the Game Room with Roster. |
| SYSTEM.SYNC | L1 \-\> Client. | **Downstream.** Full state replacement on connect. |
| SYSTEM.NOTIFY | L2/L3 \-\> L1. | **Upstream.** Triggers OneSignal Push API. |
| SYSTEM.PRIVATE\_MESSAGE | L2 \-\> Client. | **Downstream.** Targeted message (Power results). |
| SYSTEM.\* | L2 Lifecycle. | **Blocked.** L2 handles (Pause, Resume). |
| SOCIAL.\* | L3 Social OS. | **Routable.** Forwarded to L3 (DMs, Powers). |
| GAME.\* | L3 Main Stage. | **Routable.** Forwarded to L3 Cartridge (Trivia). |
| ACTIVITY.\* | L3 Activity Layer. | **Routable.** Forwarded to L3 (Side Quests). |
| INTERNAL.\* | L3 Internal. | **Private.** Self-Generated (Timeline). L1 REJECTS if from Client. |
| FACT.\* | L3 \-\> L2. | **Upstream.** Reporting for Journal/Destinies. |

## **6\. Client Architecture (PWA Mandate)**

To ensure reliable Push Notifications on iOS without an App Store app, the Client **MUST** be a PWA.

### **6.1 Technology Stack**

* **Framework:** React 18+ (TypeScript).  
* **Build Tool:** Vite.  
* **Networking:** partysocket (Official PartyKit client).  
* **Hosting:** Cloudflare Pages.

### **6.2 Service Worker Strategy**

* **OneSignal Worker:** Must be registered at the root scope to handle "Tab Closed" push events.  
* **Cache Strategy:** Use vite-plugin-pwa to cache Shell assets (Fonts, CSS) for offline resilience, but **never** cache Game Logic (Cartridges) aggressively to avoid stale code.

### **6.3 The "Install" Flow**

The Shell must detect the user's environment:

* **iOS Mobile:** Display a mandatory "Add to Home Screen" tutorial overlay. This is required to unlock the Push Notification API.  
* **Android/Desktop:** Request Notification Permission directly via OneSignal SDK.

### **6.4 Dynamic Cartridge Loading**

To prevent bundle bloat, minigame components are **Lazy Loaded** based on the Server's gameType signal.

* **Mapping:** CARTRIDGE\_REGISTRY maps server keys (TRIVIA) to import('./games/Trivia').  
* **Pre-fetching:** L2 sends SYSTEM.PRELOAD signals 5 minutes before a phase change to ensure assets are ready.

## **7\. Implementation Strategy**

1. **Build P1 (Lobby Service):**  
   * Next.js/Remix app on Cloudflare Pages.  
   * Gemini API Route.  
   * D1 Database schema for Lobbies.  
2. **Setup L1 (PartyKit):**  
   * POST /init webhook to receive Roster from P1.  
   * D1 binding for Journal.  
3. **Build L2/L3 Machines:**  
   * L2 Orchestrator (starts in PreGameSleep).  
   * L3 Daily Session (Parallel Regions).  
4. **Build Client Shell:**  
   * Login Screen checks P1 for Lobby Status.  
   * If Game Started \-\> Connects to L1 (PartyKit).  
5. **Build Cartridges:** Trivia, Vote.  
6. **Connect D1:** Journal writing in L2 FACT.RECORD handler.