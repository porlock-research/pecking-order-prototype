# Feature 1: The Lobby (P1)

**Status:** In Progress (Refactoring for Security & AI)
**Goal:** Allow a Host to create a game, generate a secure invite link, and finalize the roster with *Real* AI-generated personas.

## **1. User Stories**
1.  **Host:** "I want to create a new game and get a secure link (no PII in URL)."
2.  **Host:** "I want to click a button to generate *actual* funny persona options for my players using Google Gemini."
3.  **Player:** "I want to join via a link, pick a persona, and have my real identity hidden from everyone else."
4.  **Host:** "I want to see who has joined (as their Persona) and 'Start Game' to trigger the real server handoff."

## **2. Technical Requirements**
*   **Framework:** Next.js (App Router) on Cloudflare Pages.
*   **Database:** Cloudflare D1 (SQLite) via Drizzle ORM.
*   **AI:** `google-generative-ai` SDK (Gemini Pro).
*   **Auth:** 
    *   **Host:** Simple Admin Password or "Owner Cookie".
    *   **Players:** Anonymous Session Cookie (signed).
    *   **Identity Masking:** API *never* returns emails to the client.
*   **Limits:** Max 8 Players per Game.

## **3. Data Schemas (D1)**

### **Lobby Table**
*   `id`: string (UUID)
*   `code`: string (Short 6-char invite code)
*   `host_cookie`: string (Secret to identify host)
*   `config_json`: string (JSON: { theme: "Sci-Fi", gameMode: "BLITZ" })
*   `status`: "OPEN" | "LOCKED" | "CLOSED"

### **LobbyPlayers Table**
*   `lobby_id`: FK
*   `user_cookie`: string (Secret to identify player session)
*   `email`: string (Encrypted or just stored for notifications, NEVER sent to client)
*   `persona_id`: FK
*   `is_host`: boolean

## **4. API Endpoints (Next.js Actions & Routes)**

*   `createLobby`: Server Action. Generates `code` and `host_cookie`.
*   `joinLobby`: Server Action. Sets `user_cookie`.
*   `generatePersonas`: Server Action. Calls Google Gemini.
*   `claimPersona`: Server Action. Links `user_cookie` to `persona_id`.
*   `startGame`: Server Action. **Triggers Handoff.**
*   `/api/lobby/[code]`: GET. Returns **PublicLobbyState** (No PII).

## **5. The Handoff (Critical)**

When `startGame` is clicked:
1.  **Validation:** Check 8 players, all ready.
2.  **Compilation:** Convert D1 rows into `Roster` JSON.
3.  **Transmission:** `POST https://game-server.peckingorder.com/game/init` with `Roster` and `Manifest`.
4.  **Redirect:** Send all clients to `app.peckingorder.com/game/[id]`.

## **6. Verification**
*   [ ] **Security:** Inspect Network Tab. Ensure NO emails are visible in `/api/lobby/[code]`.
*   [ ] **AI:** Verify personas are actually generated by Gemini (not hardcoded).
*   [ ] **Handoff:** Verify the Game Server receives the POST and wakes up.